pico-8 cartridge // http://www.pico-8.com
version 29
__lua__
#include main.lua
-->8
#include gameloop.lua
-->8
#include ui.lua
-->8
#include cursor.lua
-->8
#include units.lua
-->8
--ai

function check_if_out_of_moves(player)
	local b=true
	for u in all(units) do
		if(u.player==player and not is_unit_idle(u)) b=false
	end
	
	return b
end

function get_movelist()
	local ml={}
	local x=selected.x
	local y=selected.y
	local move=selected.move
	local xstep=0
	for i=x-move,x+move,1 do
		if(i>-1 and i<gxy) then
			--diamond shape
			xstep=move-abs(x-i)
			
			--reverse diamond
			--xstep=abs(x-i)
			for j=y-xstep,y+xstep,1 do
				if(j>-1 and j<gxy) then
					--spr(61,gposx(i),gposy(j))
					
					add(ml,{i,j})
				end
			end
		end
	end
	
	movelist=check_valid_moves(ml)
end

function check_valid_moves(moves)
	local x=selected.x
	local y=selected.y
	
	for m in all(moves) do
		for u in all(units) do
				if(m[1]==x and m[2]==y) then del(moves,m)
				elseif (m[1]==u.x and m[2]==u.y) then del(moves,m)
			end
		end
	end
	
	return moves
end

function contains_move(x,y)
	for m in all(movelist) do
		if(m[1]==x and m[2]==y) return true
	end
	
	return false
end

function getfirelist(player)
	local o = selected
	ml = {}
	for e in all(units) do
		if(not e.player==o.player) then
			b = checkfirerange(o,e)
			if(b==true) add(ml,e)
		end
	end
	
	movelist=ml
end

function contains_target(e)
	for m in all(movelist) do
		if(e==m) return true
	end
	
	return false
end

function checkfirerange(e1,e2)
	if(e1==e2) return false
	local xstep=e1.weprng-abs(e1.x-e2.x)
	local ystep=e1.weprng-abs(e1.y-e2.y)
	if(abs(e1.x-e2.x)<=ystep
	and abs(e1.y-e2.y)<=xstep) then
		return true
	else return false
	end
end


function enemy_move_closest()
	--unit and enemy unit
	u = get_next_ready_unit(false)

	if(u==nil) then
		err=true
		return 
	end
	--if(u==nil) then return end
	eu = nil
	for _u in all(units) do
		if(_u.player) then
			_u.dist=get_unit_dist(u,_u)
			if(eu==nil) then eu=_u
			else
				if(_u.dist<eu.dist) then
					eu.dist=0
					eu=_u
				end
			end
		end
	end

	--now we have closest enemy unit
	--if we aren't in range, move
	if(not e_chk_rng(u,eu)) then
		local x=sgn(eu.x-u.x)*u.move
		local y=sgn(eu.y-u.y)*u.move
		
		move_unit(u,x,y)

		--if we aren't still in range,
		--do nothing
		if(not e_chk_rng(u,eu)) then
			u.attacked=true
			return
		else damage_unit(eu,u.wepdmg)
		end
	else damage_unit(eu,u.wepdmg)
	end
	
	u.moved=true
	u.attacked=true
end

-- if target in range then true
-- else false
function e_chk_rng(u,eu)
    local xstep=u.weprng-abs(u.x-eu.x)
    local ystep=u.weprng-abs(u.y-eu.y)
    if(sgn(xstep)<0 or sgn(ystep)<0) then return false
    else return true
    end
end
-->8
#include common.lua
-->8
#include player.lua
-->8
#include messagelog.lua
__gfx__
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000033033033cc0000cc000000008000000990000008
00000000000dd0000d0000000000ddd0000dd00000dd000000000dd00000000000000000000000000000000030000003c000000c0cc00cc00800000990000080
00700700000dd00000ddd000000d00d0000dd0000dddd0000dddddd00000000000000000000000000000000000000000000000000c0000c00080000990000800
0007700000d00d000d000dd00dd000d000d00d0000d00dd00dd00d00000000000000000000000000000000003000000300000000000000000008000990008000
0007700000d00d000d000dd000d00d000dd00dd000d00dd000d00d00000000000000000000000000000000003000000300000000000000000000800990080000
0070070000d00d0000ddd000000dd0000dddddd00dddd0000d0ddd000000000000000000000000000000000000000000000000000c0000c00000080990800000
000000000d0dd0d00d0000000000d00000d00d0000dd000000d0dd000000000000000000000000000000000030000003c000000c0cc00cc00000008998000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000033033033cc0000cc000000009999999889999999
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000bb00000000000000000000009999999889999999
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b000000000000000000000000000008998000000
00000000000dd00000dd000000dddd00000dd00000ddd000000dd000000000000000000000000000000000000000000000000000000000000000080990800000
00000000000dd00000d0dd0000d0dd0000dddd000000dd0000d0dd00000000000000000000000000000000000000000000000000000000000000800990080000
0000000000d00d0000d0dd00000d0d0000d00d000000dd0000000d00000000000000000000000000000000000000000000000000000000000008000990008000
0000000000dddd0000dd00000000dd0000d00d0000ddd0000000d000000000000000000000000000000000000000000000000000000000000080000990000800
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000c0800000990000080
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000088000000cc8000000990000008
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000dd0000ddd00000000ddd0000dd000000dd00000d00dd0000000000000000000000000000000000000000000000000000dd0000000800dd0080000
00000000000dd000000dd00000dd00d0000dd00000dd00000d00ddd0000000000000000000000000000000000000000000e00e0000d00d000000800dd0080000
0000000000d00d000dd00dd00d0d00d00d0dd0d00d00ddd00d0ddd000000000000000000000000000000000000000000000ee0000d0dd0d0000880d00d088000
000000000dd00dd00dd00dd0000ddd000dd00dd00d00ddd000d0d0000000000000000000000000000000000000000000000ee0000d0dd0d0080800d00d008080
000000000d0dd0d0000dd00000000d0000d00d0000dd00000d0d00d0000000000000000000000000000000000000000000e00e0000d00d00080880d00d088080
000000000d0dd0d00ddd00000000d000000dd000000dd0000dd0dd00000000000000000000000000000000000000000900000000000dd000080000d00d000080
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099000000000000000008000d0000d00080
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000880dd0880dd0880
0000000000d00d00000ddd00000dd000000000000000000000000000000000000000000000000000000000000000000000000000000000000080dd0880dd0800
000000000dd00dd000d0ddd000d000000000000000000000000000000000000000000000000000000000000000000000000dd0000000000008800d0000d00880
000000000dd00dd00d0d00000dd000d0000000000000000000000000000000000000000000000000000000000000000000d00d0000088000080000d00d000080
000000000d0dd0d00d0d00000d0d00d0000000000000000000000000000000000000000000000000000000000000000000d00d0000088000000000d00d000000
0000000000d00d0000d0ddd000d0dd0000000000000000000000000000000000000000000000000000000000e0e00000000dd000000000000000000dd0000000
00000000000dd000000ddd00000dd00000000000000000000000000000000000000000000000000000000000eee0000000000000000000000000000dd0000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e0e0000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002020200000000000000000000010100020202000000000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0e0f141414141400000014000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1e1f141414141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1214141401141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1412141414141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1414141414141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1414021402141400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1414141414140700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
